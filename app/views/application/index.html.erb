<script src="//maps.google.com/maps/api/js?v=3.13&amp;sensor=false&amp;libraries=geometry" type="text/javascript"></script>
<script src='//google-maps-utility-library-v3.googlecode.com/svn/tags/markerclustererplus/2.0.14/src/markerclusterer_packed.js' type='text/javascript'></script>
  
    <div id='map' class="filter"> 
      <div id="search-baaaaar">
        <%= form_for @user do |f| %>
        <%=f.label :skills %>
        <%= f.text_field :skill_name, :placeholder => 'Search' %>
        <%= f.button :submit, :html => {:class =>"button tiny"} 'Go' %>
        <%end%>
      </div>
    </div>

    <div id='gmap' style='width: 1280px;'>
    <div id="geolocation" style='width: 1280px; height: 593px;'></div>
    </div>

  <script type="text/javascript">

    var mapStyle = [{"stylers":[{"hue":"#ff1a00"},{"invert_lightness":true},{"saturation":-100},{"lightness":33},{"gamma":0.5}]},{"featureType":"water","elementType":"geometry","stylers":[{"color":"#2D333C"}]}];

    handler = Gmaps.build('Google');
    var init_map = handler.buildMap({ 
    provider: {
      zoom:      15,
      // center:    new google.maps.LatLng(53.385873, -1.471471),
      mapTypeId: google.maps.MapTypeId.ROADMAP,
      styles:    mapStyle
    }, internal: { 
      id: 'geolocation'
    }
    }, function(){
      markers = handler.addMarkers(<%=raw @hash.to_json%>);
      handler.bounds.extendWith(markers);
      handler.fitMapToBounds();

      if (navigator.geolocation) {
        // console.log('geolocation enabled');
        navigator.geolocation.getCurrentPosition(function(position) {
        // console.log('user is located at '+position);
        var pos = {
        lat: position.coords.latitude,
        lng: position.coords.longitude
      };
      // console.log(pos)

      var marker = handler.addMarker({
        lat: position.coords.latitude,
        lng: position.coords.longitude,
        infoWindow: "CURRENT LOCATION",
        picture: {
        url: "https://cdn4.iconfinder.com/data/icons/proglyphs-free/512/Darth_Vader-128.png",
        width:  128,
        height: 128 
      }
      });
      handler.map.centerOn(marker);

      }, function() {
       handleLocationError(true, infoWindow, init_map.getCenter());
      });
      } else {
      // Browser doesn't support Geolocation
        handleLocationError(false, infoWindow, init_map.getCenter());
      }
    });

    function handleLocationError(browserHasGeolocation, infoWindow, pos) {
      infoWindow.setPosition(pos);
      infoWindow.setContent(browserHasGeolocation ?
      'Error: The Geolocation service failed.' :
      'Error: Your browser doesn\'t support geolocation.');
    }

     $('#search-baaaaar form').on('submit', function() {
      $.ajax({
        url: '/users',
        data: {
          search: $('[name=skill_name]').val();
        },
        type: 'GET',
        dataType: 'json',
        success: function(data) {
          console.log(data);
          var map = $('#geolocation');
          $('#map').removeClass('filter');
          map.clear();
          map.addMarkers(data);
          map.setCenter(currentLocation);
        }
      });
      return false;
     })

  </script>